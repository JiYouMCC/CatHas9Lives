function makeCards(e){for(var r=[],t=0;t<e.length;++t)for(var a=e[t],n=0;n<a.count;n++)r.push(a.card)
return r}function getCards(e,r){for(var t=[],a=0;a<e.length;a++){var n=e[a]
n.type==r&&t.indexOf(n.name)==-1&&t.push(n.name)}return t}function license(e){for(var r=makeCards(e.cardTable),t=e.players,a=0,n=[],o=r.length-t.length*e.cardEach,l=getCards(r,CardType.Privilege);;){n=[],a=0,r=makeCards(e.cardTable)
for(var d=0;d<t.length;d++){var c=t[d]
c.clearCards()}for(var d=0;d<o;d++){var u=void 0,i=void 0
do i=randomArray(r),u=r[i]
while(u.cardType==CardType.Identity||e.keepResource&&u.cardType==CardType.Resource)
n.push(u),r.splice(i,1)}if(!licenseResource(r,t,e.resourceRange))return{result:!1,abandonCards:[],players:[]}
for(var p=0,s=!1;r.length>0;){if(a>e.retryTime){s=!0,console.log("发牌无解，重发")
break}var i=randomArray(r),u=r[i],c=t[p]
if(c.cards.length!=e.cardEach)if(u.cardType==CardType.Identity&&c.typeCardCount(CardType.Identity)>0)a++
else{for(var m=!1,d=l.length-1;d>=0;d--){var C=l[d]
if(u.name==C&&c.hasCard(C)){m=!0
break}}m?a++:(c.giveCard(u),r.splice(i,1),p++,p==t.length&&(p=0))}else p++,p==t.length&&(p=0)}if(!s){calCamp(t,e.optionalCount,e.killerHelperCount,e.werewolfHelperCount)
break}}return{result:!0,abandonCards:n,players:t}}function licenseResource(e,r,t){for(var a=[],n=e.length-1;n>=0;n--){var o=e[n]
o.type==CardType.Resource&&(a.push(o),e.splice(n,1))}var l=t[0],d=t[1]
if(a.length<l*r.length||a.length>d*r.length)return!1
for(var n=0;n<r.length;n++)for(var c=r[n],u=0;u<l;u++)c.giveCard(a.pop())
for(;a.length>0;){var i=randomArray(r),c=r[i]
c.typeCardCount(CardType.Resource)<d&&c.giveCard(a.pop())}return!0}function calCamp(e,r,t,a){for(var n=[],o=0;o<e.length;o++){var l=e[o]
l.hasCard("杀手牌")?l.setCamp(Camp.Killer):l.hasCard("狼人牌")?l.setCamp(Camp.Werewolf):(l.setCamp(Camp.Unknow),n.push(l))}for(var o=0;o<r;o++){var d=randomArray(n),c=n[d]
c.setCamp(Camp.Optional),n.splice(d,1)}for(var o=0;o<t;o++){var d=randomArray(n),c=n[d]
c.setCamp(Camp.KillerHelper),n.splice(d,1)}for(var o=0;o<a;o++){var d=randomArray(n),c=n[d]
c.setCamp(Camp.WereWolfHelper),n.splice(d,1)}for(var o=n.length-1;o>=0;o--)n[o].setCamp(Camp.People)}function randomArray(e){return Math.floor(Math.random()*e.length)}function getPlayers(e){for(var r=document.getElementById("players").value,t=r.split("\n"),a=[],n=0;n<Math.min(t.length,e);n++)a.push(new Player(t[n]))
if(e>t.length)for(var n=1;n<=e-t.length;n++)a.push(new Player("没名字玩家"+n))
return a}function getCardTable(){var e=[]
return processCardStr(document.getElementById("cardIdentity").value,CardType.Identity,e),processCardStr(document.getElementById("cardResource").value,CardType.Resource,e),processCardStr(document.getElementById("cardPrivilege").value,CardType.Privilege,e),e}function processCardStr(e,r,t){for(var a=e.split("\n"),n=0;n<a.length;n++){var o=a[n],l=o.split(",")
t.push(new CardTableItem(new Card(l[0],r),+l[1]))}}function doingLicense(){var e=getCardTable(),r=new Rule,t=+document.getElementById("playerCount").value
r.players=getPlayers(t),r.cardEach=+document.getElementById("cardEach").value,r.cardTable=e,r.optionalCount=+document.getElementById("optionalCount").value,r.killerHelperCount=+document.getElementById("killerHelperCount").value,r.werewolfHelperCount=+document.getElementById("werewolfHelperCount").value,r.keepResource=document.getElementById("keepResource").checked,r.resourceRange=[+document.getElementById("resourceMin").value,+document.getElementById("resourceMax").value],r.retryTime=20
for(var a=license(r),n="<tr><th>编号</th><th>玩家姓名</th><th>身份</th>",o=0;o<r.cardEach;o++)n+="<th class='card_item'></th>"
n+="</tr>",document.getElementById("result").innerHTML=n
for(var o=0;o<a.players.length;o++){var l=a.players[o],d="<tr>"
d+="<td>"+(o+1).toString()+"</td>",d+="<td>"+l.name+"</td>",d+="<td class='camp"+l.camp+"'>"+CampZH[Camp[l.camp]]+"</td>"
for(var c=0;c<l.cards.length;c++){var u=l.cards[c]
d+="<td class='card"+u.cardType+"'>"+u.name+"</td>"}d+="</tr>",document.getElementById("result").innerHTML+=d}for(var i="<tr><td>弃牌</td><td colspan="+(r.cardEach+2)+">",o=0;o<a.abandonCards.length;o++){var u=a.abandonCards[o]
i+="【"+u.name+"】"}i+="</td></tr>",document.getElementById("result").innerHTML+=i}function setRule(e){document.getElementById("playerCount").value=e.playerCount.toString(),document.getElementById("cardEach").value=e.cardEach.toString(),document.getElementById("optionalCount").value=e.optionalCount.toString(),document.getElementById("killerHelperCount").value=e.killerHelperCount.toString(),document.getElementById("werewolfHelperCount").value=e.werewolfHelperCount.toString(),document.getElementById("resourceMin").value=e.resourceRange[0].toString(),document.getElementById("resourceMax").value=e.resourceRange[1].toString(),document.getElementById("keepResource").checked=e.keepResource,document.getElementById("cardIdentity").value=e.cardIdentity,document.getElementById("cardResource").value=e.cardResource,document.getElementById("cardPrivilege").value=e.cardPrivilege}var Camp
!function(e){e[e.Killer=1]="Killer",e[e.Werewolf=2]="Werewolf",e[e.People=3]="People",e[e.Optional=4]="Optional",e[e.KillerHelper=5]="KillerHelper",e[e.WereWolfHelper=6]="WereWolfHelper",e[e.Unknow=7]="Unknow"}(Camp||(Camp={}))
var CampZH={Killer:"杀手",Werewolf:"狼人",People:"平民",Optional:"可选",KillerHelper:"杀助",WereWolfHelper:"狼崽",Unknow:"未知"},CardType
!function(e){e[e.Identity=1]="Identity",e[e.Privilege=2]="Privilege",e[e.Resource=3]="Resource"}(CardType||(CardType={}))
var Card=function(){function e(e,r){this.cardName=e,this.cardType=r,this.name=e,this.type=r}return e}(),CardTableItem=function(){function e(e,r){this.theCard=e,this.cardCount=r,this.card=e,this.count=r}return e}(),Player=function(){function e(e){this.playerName=e,this.name=e,this.cards=[],this.camp=Camp.Unknow}return e.prototype.hasCard=function(e){for(var r=0;r<this.cards.length;r++)if(this.cards[r].name==e)return!0
return!1},e.prototype.cardCount=function(e){for(var r=0,t=0;t<this.cards.length;t++)this.cards[t].name==e&&r++
return r},e.prototype.typeCardCount=function(e){for(var r=0,t=0;t<this.cards.length;t++){var a=this.cards[t]
a.cardType==e&&r++}return r},e.prototype.giveCard=function(e){this.cards.push(e)},e.prototype.clearCards=function(){for(var e=[],r=0;r<this.cards.length;r++)e.push(this.cards[r])
return this.cards=[],e},e.prototype.setCamp=function(e){this.camp=e},e}(),Rule=function(){function e(){}return e}(),rule_7={playerCount:7,cardEach:5,optionalCount:1,killerHelperCount:0,werewolfHelperCount:0,resourceRange:[1,2],keepResource:!1,cardIdentity:"杀手牌,1\n狼人牌,1",cardResource:"庶民牌,12",cardPrivilege:"狙击手牌,2\n束魂牌,2\n巫医牌,2\n防弹衣/狼毒牌,2\n禁锢/反狙击牌,2\n绝杀/特赦牌,2\n诅咒/庇佑牌,2\n纵火/圣人牌,2\n保镖牌,3\n阿米巴变形牌,3"},rule_9={playerCount:9,cardEach:5,optionalCount:0,killerHelperCount:1,werewolfHelperCount:1,resourceRange:[2,2],keepResource:!0,cardIdentity:"杀手牌,1\n狼人牌,1",cardResource:"资源牌,18",cardPrivilege:"纵火/圣人牌,2\n绝杀/特赦牌,2\n禁锢/反狙击牌,2\n防弹衣/狼毒牌,2\n狙击手牌,3\n束魂牌,3\n巫医牌,3\n诅咒/庇佑牌,3\n保镖牌,4\n变形牌,4"},rule_single={playerCount:12,cardEach:1,optionalCount:0,killerHelperCount:0,werewolfHelperCount:0,resourceRange:[0,1],keepResource:!1,cardIdentity:"杀手牌,3",cardResource:"平民牌,9",cardPrivilege:""},rule_20={playerCount:12,cardEach:1,optionalCount:0,killerHelperCount:0,werewolfHelperCount:0,resourceRange:[0,1],keepResource:!1,cardIdentity:"杀手牌,3",cardResource:"平民牌,6",cardPrivilege:"警察牌,3"}
